# AGENTS.md

本文件是给在本仓库工作的 AI/Agent 的工程上下文与执行约束。作用域：**仓库根目录及其所有子目录**。

> 目标：减少误解，确保后续改动与 SealVault 当前阶段一致。

---

## 1. 项目当前阶段（必须先理解）

SealVault 当前是 **Rust 引擎优先阶段**，可运行、可测试，但不是完整产品形态。

### 已完成的核心能力

1. **`.svlt` v1 文件格式落地**：Header + Stream。
2. **单文件加解密可用**：流式读写，避免整文件载入内存。
3. **目录递归加解密可用**：保留目录结构、处理 `.svlt` 后缀。
4. **算法可选**：默认 XChaCha20-Poly1305，同时支持 AES-256-GCM。
5. **原子写出语义**：失败不应污染目标输出。
6. **基础 roundtrip 测试齐备**：文件/目录、错误密码等路径已覆盖。

### 尚未完成 / 不应假设已完成

- GUI、完整产品化交互、安装器生态。
- 长期稳定格式冻结承诺（v1 仍可能迭代）。
- 跨语言（例如 C++）主实现在本仓库中并不存在。

---

## 2. 架构现实（按现有代码，不按历史设想）

- 当前核心代码在 `engine/`。
- `engine` 同时暴露：
  - 库接口（`engine::encrypt` / `decrypt` / `encrypt_folder` / `decrypt_folder`）
  - 简单 CLI 入口（`engine/src/main.rs`）
- 目录处理通过 `walkdir` 递归；路径拼接前后都有安全检查。

> 重要：不要按“engine 不包含 I/O”的理想化设想来改代码。当前实现本身就是文件系统导向的引擎。

---

## 3. 安全优先级（强约束）

所有建议与改动遵循：

1. **Security**
2. Correctness
3. Maintainability
4. Performance
5. Convenience

若出现冲突，宁可保守，不做“看起来方便但弱化安全性”的改动。

---

## 4. 加密实现约束

1. 禁止自研密码学算法。
2. 保持 KDF / AEAD / 格式层职责清晰。
3. Header 字段变更属于格式变更，需明确版本策略。
4. 随机数必须来自安全随机源。
5. 解密认证失败必须立即中止，不泄露部分明文。
6. 优先复用现有模块，不平行复制一套流程实现。

---

## 5. 目录加解密约束

1. 必须保留相对目录结构。
2. 必须拒绝不安全路径组件（`..`、绝对路径、盘符前缀等）。
3. 解密目录时仅处理 `.svlt` 文件；其余文件默认跳过。
4. 输出写入必须维持原子写语义。

---

## 6. 文档与描述约束（防“文档漂移”）

1. 先读代码与测试，再写文档。
2. 不要把“规划中”写成“已实现”。
3. 不要把历史设想（例如 C++ 分层）写成当前事实。
4. 若规范文档与实现存在偏差：
   - 在文档中明确“当前实现行为”
   - 给出“拟对齐方向”（如有）

---

## 7. 工程风格约定

- Rust 代码保持可读、可审计。
- 错误处理优先 `Result`，避免无理由 `unwrap/expect`。
- 避免炫技式抽象；优先直接、清晰的实现。
- 大改动前先确认现有测试覆盖点，并补充必要测试。

---

## 8. 变更提交约定（本仓库）

commit message 建议沿用：

```text
<icon> <type>(<scope>): <summary>

- <detail 1>
- <detail 2>
```

常用图标与类型: 

- ✨feat(scope): 新功能 
- 🛠️fix(scope): 修复 bug 
- 📄docs: 文档更新 
- 🎨style: 代码格式化
- 🔨refactor: 重构代码 
- 📦chore: 构建流程或辅助工具的变动 
- 🚨test: 测试用例或演示代码 
- 🎉release: 发布新版本

文档改动请明确写清“基于当前实现校准”，避免泛化描述。

---

## 9. AI 执行清单（每次改动前自检）

在动手前，至少回答以下问题：

1. 这次改动是否与当前阶段一致（而非理想未来架构）？
2. 是否会影响 `.svlt` 格式兼容性？
3. 是否破坏原子写或错误路径安全语义？
4. 是否需要更新测试与文档？

若任何问题答案不明确，先补充调查再实施改动。
